name: Validate PR Title

on:
  pull_request:
    types: [opened, edited, synchronize]

permissions:
  pull-requests: write
  contents: read
  issues: write

jobs:
  validate-pr-title:
    runs-on: ubuntu-latest
    steps:
      - name: Extract branch name
        id: branch
        run: |
          BRANCH_NAME="${{ github.head_ref }}"
          echo "name=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: Validate branch name format
        id: validate
        run: |
          BRANCH_NAME="${{ steps.branch.outputs.name }}"
          
          # Use perl for robust regex matching (PCRE)
          # We check two cases:
          # 1. Branch starts with the ticket ID (e.g. DM-123, encore-983483)
          # 2. Branch has a prefix before the ticket ID (e.g. web-DM-123)
          
          # Ticket patterns:
          # - Uppercase-Number (EM-743)
          # - Lowercase-Number (encore-123)
          # - Number only (743)
          
          PARSED=$(echo "$BRANCH_NAME" | perl -ne '
            $ticket_pat = "([A-Z]{1,}[-_][0-9]+|[a-z]+[-_][0-9]+|[0-9]+)";
            
            # Case 1: Starts with ticket
            if (/^$ticket_pat(.*)$/) {
              print "PREFIX=\"\"\nTICKET=\"$1\"\nDESCRIPTION=\"$2\"";
            } 
            # Case 2: Prefix + Ticket (non-greedy prefix)
            elsif (/^(.+?)[-_]$ticket_pat(.*)$/) {
              print "PREFIX=\"$1\"\nTICKET=\"$2\"\nDESCRIPTION=\"$3\"";
            }
          ')
          
          if [ -n "$PARSED" ]; then
            eval "$PARSED"
            
            echo "prefix=$PREFIX" >> $GITHUB_OUTPUT
            echo "ticket=$TICKET" >> $GITHUB_OUTPUT
            echo "description=$DESCRIPTION" >> $GITHUB_OUTPUT
            echo "Branch name matches expected pattern: $BRANCH_NAME"
            echo "Parsed - Prefix: '$PREFIX', Ticket: '$TICKET', Description: '$DESCRIPTION'"
            
            # Determine if there's a real description (ignoring separators and whitespace)
            CLEAN_DESC=$(echo "$DESCRIPTION" | sed 's/[-_]//g' | sed 's/^ *//; s/ *$//')
            if [ -z "$CLEAN_DESC" ]; then
              echo "has_description=false" >> $GITHUB_OUTPUT
              echo "::warning title=Missing description::There's no description in your branch, this makes it harder to understand at a glance what the work is"
            else
              echo "has_description=true" >> $GITHUB_OUTPUT
            fi
          else
            echo "Branch name does not match expected <anything>-<ticket-id> pattern"
            echo "Branch name: $BRANCH_NAME"
            exit 1
          fi
      
      - name: Comment if missing description
        if: steps.validate.outputs.has_description == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const body = "Heads up: There's no description in your branch name after the ticket ID. Adding a short description helps reviewers understand the change at a glance.";
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body,
            });

      - name: Generate expected PR title
        id: expected
        run: |
          PREFIX="${{ steps.validate.outputs.prefix }}"
          TICKET="${{ steps.validate.outputs.ticket }}"
          DESCRIPTION="${{ steps.validate.outputs.description }}"
          
          # Replace remaining separators with spaces and collapse extra spaces
          DESCRIPTION=$(echo "$DESCRIPTION" | sed 's/[-_]/ /g' | sed 's/  \+/ /g' | sed 's/^ //; s/ $//')
          
          # Build the header (with or without prefix)
          if [ -n "$PREFIX" ]; then
            PREFIX_TITLE=$(echo "${PREFIX:0:1}" | tr '[:lower:]' '[:upper:]')${PREFIX:1}
            if [[ "$TICKET" =~ ^[0-9]+$ ]]; then
              HEADER="$PREFIX_TITLE-$TICKET"
            else
              HEADER="$PREFIX_TITLE $TICKET"
            fi
          else
            HEADER="$TICKET"
          fi
          
          # Build the final title
          if [ -z "$DESCRIPTION" ]; then
            EXPECTED_TITLE="$HEADER"
          else
            EXPECTED_TITLE="$HEADER $DESCRIPTION"
          fi
          
          echo "title=$EXPECTED_TITLE" >> $GITHUB_OUTPUT
          echo "Expected PR title: $EXPECTED_TITLE"

      - name: Update PR title if needed
        if: github.event.pull_request.title != steps.expected.outputs.title
        uses: actions/github-script@v7
        with:
          script: |
            const newTitle = '${{ steps.expected.outputs.title }}';
            const currentTitle = '${{ github.event.pull_request.title }}';
            
            console.log(`Updating PR title from "${currentTitle}" to "${newTitle}"`);
            
            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              title: newTitle
            });
            
            console.log('âœ… PR title updated successfully');