name: Validate PR Title

on:
  pull_request:
    types: [opened, edited, synchronize]

permissions:
  pull-requests: write
  contents: read

jobs:
  validate-pr-title:
    runs-on: ubuntu-latest
    steps:
      - name: Extract branch name
        id: branch
        run: |
          BRANCH_NAME="${{ github.head_ref }}"
          echo "name=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: Validate branch name format
        id: validate
        run: |
          BRANCH_NAME="${{ steps.branch.outputs.name }}"
          REGEX='^(.*?)[-_]?([a-zA-Z0-9]+-[0-9]+)'
          
          if [[ $BRANCH_NAME =~ $REGEX ]]; then
            echo "prefix=${BASH_REMATCH[1]}" >> $GITHUB_OUTPUT
            echo "ticket=${BASH_REMATCH[2]}" >> $GITHUB_OUTPUT
            echo "Branch name matches expected pattern: $BRANCH_NAME"
          else
            echo "Branch name does not match expected <prefix>[-| ]<ticket-id> pattern"
            echo "Branch name: $BRANCH_NAME"
            exit 1
          fi

      - name: Generate expected PR title
        id: expected
        run: |
          BRANCH_NAME="${{ steps.branch.outputs.name }}"
          PREFIX="${{ steps.validate.outputs.prefix }}"
          TICKET="${{ steps.validate.outputs.ticket }}"
          
          # Start with the full branch name and strip the leading prefix + ticket (if present)
          DESCRIPTION="$BRANCH_NAME"
          if [ -n "$PREFIX" ]; then
            DESCRIPTION=$(echo "$DESCRIPTION" | sed -E "s/^${PREFIX}[-_]?//")
          fi
          DESCRIPTION=$(echo "$DESCRIPTION" | sed -E "s/^${TICKET}[-_]?//")
          # Replace remaining separators with spaces and collapse extra spaces
          DESCRIPTION=$(echo "$DESCRIPTION" | sed 's/[-_]/ /g' | sed 's/  \+/ /g' | sed 's/^ //; s/ $//')
          
          # Build the header (with or without prefix)
          if [ -n "$PREFIX" ]; then
            PREFIX_TITLE=$(echo "${PREFIX:0:1}" | tr '[:lower:]' '[:upper:]')${PREFIX:1}
            HEADER="$PREFIX_TITLE $TICKET"
          else
            HEADER="$TICKET"
          fi
          
          # Build the final title
          if [ -z "$DESCRIPTION" ]; then
            EXPECTED_TITLE="$HEADER"
          else
            EXPECTED_TITLE="$HEADER $DESCRIPTION"
          fi
          
          echo "title=$EXPECTED_TITLE" >> $GITHUB_OUTPUT
          echo "Expected PR title: $EXPECTED_TITLE"

      - name: Update PR title if needed
        if: github.event.pull_request.title != steps.expected.outputs.title
        uses: actions/github-script@v7
        with:
          script: |
            const newTitle = '${{ steps.expected.outputs.title }}';
            const currentTitle = '${{ github.event.pull_request.title }}';
            
            console.log(`Updating PR title from "${currentTitle}" to "${newTitle}"`);
            
            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              title: newTitle
            });
            
            console.log('âœ… PR title updated successfully');